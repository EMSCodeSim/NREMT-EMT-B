<script>
  let totalTime = 15 * 60;
  let countdown;
  let scenarioActive = false;
  let history = [];
  let currentScenario = null;
  let imageShown = false;

  function startTimer() {
    const timer = document.getElementById('start-button');
    scenarioActive = true;
    countdown = setInterval(() => {
      const mins = Math.floor(totalTime / 60);
      const secs = totalTime % 60;
      timer.textContent = 'ðŸ•’ ' + String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
      if (totalTime <= 0) {
        clearInterval(countdown);
        timer.textContent = 'â° Time is up!';
        scenarioActive = false;
      }
      totalTime--;
    }, 1000);
  }

  function stopTimer() {
    clearInterval(countdown);
    document.getElementById('start-button').textContent = 'â¹ Scenario Ended';
    scenarioActive = false;
  }

  async function sendMessage(messageOverride = null) {
    const input = document.getElementById('user-input');
    const message = messageOverride || input.value.trim();
    if (!message) return;

    const chat = document.getElementById('chat-display');
    const userMsg = document.createElement('div');
    userMsg.className = 'chat-message';
    userMsg.textContent = message;
    chat.appendChild(userMsg);
    chat.scrollTop = chat.scrollHeight;

    // Show patient image if contact made
    if (!imageShown && currentScenario?.media_triggers?.on_contact && /contact|what.*look|see/i.test(message)) {
      const trigger = currentScenario.media_triggers.on_contact;
      if (trigger.startsWith("show_image:")) {
        const img = document.createElement("img");
        img.src = `/scenarios/${trigger.replace("show_image:", "")}`;
        img.alt = "Patient";
        img.className = "chat-image";
        chat.appendChild(img);
        chat.scrollTop = chat.scrollHeight;
        imageShown = true;
      }
    }

    if (scenarioActive && /transport(ed)? by ambulance/i.test(message)) {
      stopTimer();
    }

    input.value = '';

    try {
      const response = await fetch('/.netlify/functions/handleChat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message, history, scenario: currentScenario })
      });

      const data = await response.json();
      history = data.updatedHistory;

      const botReply = data?.reply || 'âš ï¸ No response received from patient.';
      const botMsg = document.createElement('div');
      botMsg.className = 'chat-message';
      botMsg.textContent = botReply;
      chat.appendChild(botMsg);
      chat.scrollTop = chat.scrollHeight;

      speakText(botReply);
    } catch {
      const errMsg = document.createElement('div');
      errMsg.className = 'chat-message';
      errMsg.textContent = 'Error communicating with AI.';
      chat.appendChild(errMsg);
    }
  }

  function speakText(text) {
    const synth = window.speechSynthesis;
    const utter = new SpeechSynthesisUtterance(text);
    synth.speak(utter);
  }

  function endScenario() {
    stopTimer();
    const chat = document.getElementById('chat-display');
    const endMsg = document.createElement('div');
    endMsg.className = 'chat-message';
    endMsg.textContent = 'ðŸš‘ Scenario ended. Preparing summary and feedback...';
    chat.appendChild(endMsg);
  }

  function startVoiceInput() {
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = function(event) {
      const speechResult = event.results[0][0].transcript;
      sendMessage(speechResult);
    };

    recognition.onerror = function(event) {
      alert('Mic error: ' + event.error);
    };

    recognition.start();
  }

  async function startRandomScenario() {
    try {
      const file = "chest_pain_001.json";
      const res = await fetch(`/scenarios/${file}`);
      currentScenario = await res.json();
      imageShown = false;
      history = [];

      const chat = document.getElementById('chat-display');
      chat.innerHTML = '';

      const dispatch = document.createElement('div');
      dispatch.className = 'chat-message';
      dispatch.textContent = `ðŸ“Ÿ Dispatch: ${currentScenario.dispatch}`;
      chat.appendChild(dispatch);

      totalTime = 15 * 60;
      startTimer();
    } catch (error) {
      const chat = document.getElementById('chat-display');
      const errMsg = document.createElement('div');
      errMsg.className = 'chat-message';
      errMsg.textContent = "âš ï¸ Scenario file could not be loaded.";
      chat.appendChild(errMsg);
      console.error(error);
    }
  }
</script>
